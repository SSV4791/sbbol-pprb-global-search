---
kind: ConfigMap
apiVersion: v1
metadata:
  name: cm-fluentbit-{{ canary_suffix }}
data:
  fluent-bit.conf: >-
    [SERVICE]
        Flush        1
        Daemon       Off
        Parsers_File /fluent-bit/etc/parsers.conf
        HTTP_Server  On
        HTTP_Listen  0.0.0.0
        HTTP_PORT    2020
    [INPUT]
        Name tail
        Path /app/logs/*.json
        Mem_Buf_Limit 10MB
        Skip_Long_Lines On
        Refresh_Interval 2
        Rotate_Wait 1
        Read_from_Head Off
        DB /app/logs/kube.db
        Parser custom
    [FILTER]
        Name modify
        Match *
        Add cluster ${cluster}
        Add pod ${pod}
        Add moduleId ${moduleId}
        Add moduleVersion ${moduleVersion}
        Add nodeId ${nodeId}
        Add standId ${standId}
    [OUTPUT]
        Name kafka
        Match file.tail
        timestamp_key time
        Topics {{ fluentbit.kafka.topic | default('tengri_kafka') }}
        Brokers {% for address in infra_entry.tengri %}{{ address.host }}:{{ address.port }}{% if not loop.last %},{% endif %}{% endfor %}

        rdkafka.security.protocol PLAINTEXT
    [OUTPUT]
        Name stdout
        Match *
  parsers.conf: |-
    [PARSER]
        Name custom
        Format json
